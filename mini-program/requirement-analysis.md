# 西浦博士生非官方指南微信小程序实现方案

## 1. 技术架构设计

### 1.1 总体架构

- **前端**: 微信小程序原生开发
- **后端**: 微信云开发 (CloudBase)
- **数据库**: 云开发数据库
- **存储**: 云开发存储
- **API**: 云函数

### 1.2 主要技术选型

#### 前端技术
- 微信小程序原生开发框架
- WXML + WXSS 实现界面
- 使用小程序组件库如 WeUI 或自定义组件
- Katex小程序版本用于数学公式渲染
- prismjs小程序版本用于代码高亮显示

#### 后端技术
- 云函数：实现各类业务逻辑
- 云数据库：存储文档内容、用户信息、评论等数据
- 云存储：存储图片、文件资源等
- 云开发模板：使用开箱即用的云模板功能增强应用能力

## 2. 核心功能模块设计

### 2.1 内容展示模块

#### LaTeX 解析转换系统
- 开发自定义 LaTeX 解析工具，将原始文档转换为适合小程序展示的格式
- 实现解析过程：
  1. 使用解析器处理原始 LaTeX 文档
  2. 将内容转换为结构化 JSON 格式
  3. 生成符合小程序展示的标记语言
  4. 支持公式、图表、表格等复杂元素的渲染

#### 章节导航系统
- 基于原文档结构，构建多级章节导航
- 实现侧滑菜单，方便用户快速浏览和跳转
- 提供目录页面，清晰展示整个文档结构
- 记忆用户上次阅读位置

```json
{
  "章节": [
    {
      "id": "chapter1",
      "title": "Start here: 入口级网站和应用",
      "sections": [
        {
          "id": "section1_1",
          "title": "网站",
          "content": "..."
        },
        {
          "id": "section1_2",
          "title": "公众号",
          "content": "..."
        },
        ...
      ]
    },
    ...
  ]
}
```

#### 双语切换功能
- 实现中英文版本内容存储和切换
- 提供语言偏好设置，支持记住用户选择
- 使用云函数获取不同语言版本的内容

#### 资源下载功能
- 对接云存储，提供对 fileshare 目录中资源的访问
- 实现文件预览和下载功能
- 支持常见文档格式的在线预览

### 2.2 用户互动模块

#### 评论系统
- 实现基于章节和段落的评论功能
- 支持回复、点赞等社交互动
- 提供评论管理功能，包括筛选和举报

```json
{
  "评论数据结构": {
    "id": "comment_001",
    "userId": "user_123",
    "chapterId": "chapter2",
    "sectionId": "section2_3",
    "paragraphId": "para_456",
    "content": "这个部分的信息非常有用！",
    "timestamp": "2025-04-06T10:30:00Z",
    "likes": 5,
    "replies": [
      {
        "id": "reply_001",
        "userId": "user_456",
        "content": "我也这么认为！",
        "timestamp": "2025-04-06T11:15:00Z"
      }
    ]
  }
}
```

#### 搜索功能
- 实现全文搜索能力
- 支持按章节、关键词等多维度搜索
- 提供搜索结果高亮显示
- 记录热门搜索词，方便用户快速查找

#### 内容更新通知
- 利用小程序订阅消息功能，实现内容更新提醒
- 当原始文档更新后，自动通知订阅用户
- 实现更新内容的差异化展示

#### 收藏功能
- 允许用户收藏重要章节或段落
- 提供收藏列表管理
- 实现收藏内容的快速访问和分享

### 2.3 用户管理模块

#### 微信登录
- 使用微信快速登录，无需额外注册
- 获取基本用户信息，关联用户行为
- 实现登录状态持久化

#### 西浦认证
- 提供邮箱验证实名认证（通过西浦邮箱后缀验证）
- 认证用户评论可显示身份标识
- 可区分学生、老师等不同身份

#### 权限管理
- 实现多级权限控制：普通用户、认证用户和管理员
- 不同权限用户可见的功能和内容有所区别
- 管理员拥有内容管理、用户管理等高级权限

#### 用户数据安全
- 实现数据加密传输和存储
- 遵循微信小程序安全最佳实践
- 提供用户隐私设置和数据导出功能

## 3. 数据库设计

### 用户集合 (users)
```json
{
  "_id": "user_id",
  "openId": "wx_open_id",
  "nickname": "用户昵称",
  "avatar": "头像URL",
  "isVerified": false,
  "verifiedEmail": "student@xjtlu.edu.cn",
  "role": "user",
  "joinTime": "2025-04-06T10:00:00Z",
  "preferences": {
    "language": "zh_CN",
    "fontSize": "medium",
    "theme": "light"
  }
}
```

### 内容集合 (contents)
```json
{
  "_id": "content_id",
  "chapterId": "chapter1",
  "sectionId": "section1_2",
  "title": "章节标题",
  "content": "内容HTML",
  "language": "zh_CN",
  "version": "1.0.1",
  "lastUpdate": "2025-04-05T14:30:00Z",
  "order": 1,
  "keywords": ["西浦", "博士生", "入学指南"]
}
```

### 评论集合 (comments)
```json
{
  "_id": "comment_id",
  "userId": "user_id",
  "contentId": "content_id",
  "text": "评论内容",
  "createdAt": "2025-04-06T10:30:00Z",
  "likes": 5,
  "replies": [
    {
      "userId": "reply_user_id",
      "text": "回复内容",
      "createdAt": "2025-04-06T11:00:00Z"
    }
  ]
}
```

### 收藏集合 (bookmarks)
```json
{
  "_id": "bookmark_id",
  "userId": "user_id",
  "contentId": "content_id",
  "title": "收藏标题",
  "note": "用户备注",
  "createdAt": "2025-04-06T09:15:00Z"
}
```

### 文件资源集合 (resources)
```json
{
  "_id": "resource_id",
  "title": "资源标题",
  "description": "资源描述",
  "fileId": "cloud://file-id",
  "fileUrl": "https://...",
  "fileType": "pdf",
  "fileSize": 1024000,
  "uploadDate": "2025-04-01T10:00:00Z",
  "category": "表格模板",
  "downloads": 50
}
```

## 4. 云函数设计

### 内容管理云函数
- `getChapters`: 获取章节列表
- `getContent`: 获取指定内容详情
- `searchContent`: 全文搜索功能
- `checkContentUpdate`: 检查内容更新

### 用户管理云函数
- `login`: 用户登录
- `verifyEmail`: 验证西浦邮箱
- `updateUserProfile`: 更新用户资料
- `setPreferences`: 设置用户偏好

### 互动功能云函数
- `addComment`: 添加评论
- `replyComment`: 回复评论
- `likeComment`: 点赞评论
- `addBookmark`: 添加收藏
- `removeBookmark`: 删除收藏
- `subscribeUpdate`: 订阅更新通知

### 资源管理云函数
- `listResources`: 列出可下载资源
- `getResourceUrl`: 获取资源下载链接
- `recordDownload`: 记录下载统计

## 5. 页面结构设计

### 主要页面
- 首页：概览和快速入口
- 目录页：完整的章节目录树
- 内容页：显示具体章节内容
- 搜索页：提供搜索功能和结果展示
- 资源页：展示可下载的资源文件
- 收藏页：用户的收藏列表
- 个人中心：用户信息和设置

### 组件设计
- 章节导航组件：侧边栏导航
- 内容渲染组件：支持富文本、公式和图表
- 评论组件：展示和提交评论
- 搜索框组件：提供搜索建议
- 资源卡片组件：展示资源信息
- 语言切换组件：中英文切换

## 6. 实施计划

### 第一阶段：基础架构（4周）
1. 搭建项目基础架构
2. 开发 LaTeX 解析转换工具
3. 实现基本内容展示功能
4. 完成页面路由和导航系统

### 第二阶段：核心功能（6周）
1. 实现双语内容切换
2. 开发评论系统
3. 实现搜索功能
4. 完成资源下载功能
5. 基本用户认证系统

### 第三阶段：用户体验优化（4周）
1. 实现收藏和阅读历史功能
2. 添加内容更新通知
3. 开发西浦邮箱认证
4. 用户界面优化
5. 性能优化和缓存策略

### 第四阶段：测试与部署（2周）
1. 全面功能测试
2. 安全性测试
3. 性能测试
4. 部署上线
5. 用户反馈收集

## 7. 技术挑战与解决方案

### LaTeX 转换挑战
- **挑战**：复杂 LaTeX 文档的格式保留问题，特别是数学公式和特殊排版
- **解决方案**：使用专业的 LaTeX 解析库，结合 Katex 小程序版本进行公式渲染，复杂图表采用图片方式展示

### 小程序包大小限制
- **挑战**：小程序主包有 2MB 限制
- **解决方案**：采用分包加载策略，将内容按章节分包，使用云存储存储图片资源，按需加载

### 离线访问需求
- **挑战**：用户可能需要在无网络环境下访问内容
- **解决方案**：实现内容的本地缓存机制，用户可预先下载需要离线访问的章节

## 8. 后续扩展计划

### 内容创作平台
- 开发管理员内容编辑系统
- 支持直接在小程序中更新内容
- 提供内容版本管理

### 社区互动增强
- 添加问答区功能
- 实现用户间私信功能
- 开发话题标签系统

### 数据分析系统
- 用户阅读行为分析
- 内容热度统计
- 搜索关键词分析

### 多平台拓展
- 开发 H5 网页版本
- 提供 API 接口，支持第三方应用接入