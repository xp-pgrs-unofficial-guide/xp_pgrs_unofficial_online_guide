<!--index.wxml-->
<view class="container {{fontSize ? 'text-' + fontSize : 'text-normal'}} {{isLandscape ? 'landscape-mode' : ''}} {{screenSizeClass}}">
  <view class="main">
    <!-- 折叠式顶部导航 -->
    <view class="folding-nav {{ isNavCollapsed ? 'collapsed' : '' }} {{ isLandscape ? 'landscape-mode' : '' }}">
      <!-- 一级导航 (章节) -->
      <scroll-view 
        scroll-x="{{ !isLandscape }}" 
        scroll-y="{{ isLandscape }}"
        class="primary-nav {{ isLandscape ? 'primary-nav-landscape' : '' }}"
        scroll-into-view="{{primaryNavScrollId}}"
        scroll-with-animation="true"
      >
        <view 
          wx:for="{{ chapters }}" 
          wx:key="id"
          id="chapter_{{item.id}}"
          class="primary-nav-item {{ currentChapter.id === item.id ? 'active' : '' }}"
          data-chapter-id="{{ item.id }}"
          bindtap="selectChapter"
        >
          {{ currentLang === 'zh' ? item.title : item.title_en }}
          <view class="indicator" wx:if="{{ currentChapter.id === item.id }}"></view>
        </view>
      </scroll-view>
      
      <!-- 二级导航 (小节) -->
      <view class="secondary-nav {{ isSecondaryNavVisible ? 'visible' : 'hidden' }}">
        <scroll-view 
          scroll-x="{{ !isLandscape }}" 
          scroll-y="{{ isLandscape }}"
          class="secondary-nav-scroll {{ isLandscape ? 'secondary-nav-landscape' : '' }}"
          scroll-into-view="{{secondaryNavScrollId}}"
          scroll-with-animation="true"
        >
          <view 
            wx:for="{{ currentChapter.sections }}" 
            wx:key="id"
            id="section_{{item.id}}"
            class="secondary-nav-item {{ currentSection.id === item.id ? 'active' : '' }}"
            data-section-id="{{ item.id }}"
            bindtap="selectSection"
          >
            {{ currentLang === 'zh' ? item.title : item.title_en }}
          </view>
        </scroll-view>
      </view>
    </view>
    
    <!-- 内容区域 -->
    <view class="content-area {{ isLandscape ? 'landscape-mode' : '' }}">
      <view class="step_container" wx:for="{{ chapters }}" wx:key="id" wx:for-item="chapter">
        <view id="step_{{ chapter.id }}" data-step="{{ chapter.id }}" class="step_title">
          <view class="step_id_container">
            <view class="step_id_mark">Chapter</view>
            <view class="step_id_content">{{ chapter.id }}</view>
          </view>
          <view class="font_title_2">{{ currentLang === 'zh' ? chapter.title : chapter.title_en }}</view>
        </view>
        <view class="step_content">
          <block wx:for="{{ chapter.sections }}" wx:for-item="section" wx:key="id">
            <view id="section_{{ section.id }}" class="section_title font_title_3">
              {{ currentLang === 'zh' ? section.title : section.title_en }}
            </view>
            
            <!-- 内容渲染，支持多种内容类型 -->
            <view wx:if="{{ section.contents }}">
              <block wx:for="{{ section.contents }}" wx:for-item="contentItem" wx:key="index">
                <!-- 文本内容 -->
                <view wx:if="{{ contentItem.type === 'text' }}" class="text_zone">
                  <rich-text nodes="<p style='line-height: 1.6;'>{{ currentLang === 'zh' ? contentItem.content : contentItem.content_en }}</p>" />
                </view>
                
                <!-- 代码块内容 -->
                <view wx:elif="{{ contentItem.type === 'code' }}" class="code_zone">
                  <image class="btn-copy" data-code="{{ currentLang === 'zh' ? contentItem.content : contentItem.content_en }}" bind:tap="copyCode" src="../../images/icons/copy.png" />
                  <rich-text nodes="<pre style='overflow: scroll;'>{{ currentLang === 'zh' ? contentItem.content : contentItem.content_en }}</pre>" />
                </view>
                
                <!-- 图片内容 -->
                <view wx:elif="{{ contentItem.type === 'image' }}" class="image_zone">
                  <image 
                    src="{{ contentItem.cloudPath ? contentItem.cloudImageUrl : '../../images/' + contentItem.content }}" 
                    mode="{{ isLandscape ? 'aspectFit' : 'widthFix' }}"
                    bind:load="onImageLoad"
                    bind:error="onImageError"
                    data-index="{{index}}"
                    data-section-index="{{sectionIndex}}" />
                  <view wx:if="{{ contentItem.isLoading }}" class="image-loading">加载中...</view>
                  <view wx:if="{{ contentItem.loadError }}" class="image-error">图片加载失败</view>
                </view>
                
                <!-- 带链接的文本内容 -->
                <view wx:elif="{{ contentItem.type === 'text-link' }}" class="text_zone">
                  <view wx:if="{{ currentLang === 'zh' }}">
                    {{contentItem.content[0]}}<text class="text_link" bind:tap="handleLinkTap" data-link-type="{{contentItem.linkType || 'default'}}">{{contentItem.content[1]}}</text>{{contentItem.content[2]}}
                  </view>
                  <view wx:else>
                    {{contentItem.content_en[0]}}<text class="text_link" bind:tap="handleLinkTap" data-link-type="{{contentItem.linkType || 'default'}}">{{contentItem.content_en[1]}}</text>{{contentItem.content_en[2]}}
                  </view>
                </view>
              </block>
            </view>
            
            <!-- 兼容性处理：对于旧格式的内容（纯文本数组）使用默认渲染 -->
            <block wx:if="{{ section.content }}">
              <block wx:if="{{ currentLang === 'zh' }}">
                <rich-text wx:for="{{ section.content }}" wx:key="index" nodes="<p style='line-height: 1.6;'>{{ item }}</p>" />
              </block>
              <block wx:else>
                <rich-text wx:for="{{ section.content_en }}" wx:key="index" nodes="<p style='line-height: 1.6;'>{{ item }}</p>" />
              </block>
            </block>
          </block>
        </view>
        <view class="seperator" />
      </view>
    </view>
  </view>
  
  <!-- 语言切换按钮 -->
  <view class="language-toggle {{ isLandscape ? 'landscape' : '' }}" bindtap="toggleLanguage">
    <text>{{ currentLang === 'zh' ? 'EN' : '中' }}</text>
  </view>
</view>