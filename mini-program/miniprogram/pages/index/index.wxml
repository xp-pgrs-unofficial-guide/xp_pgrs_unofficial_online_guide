<!--index.wxml-->
<view class="container">
  <view class="main">
    <!-- <view class="title font_title_1">博士生非官方手册</view> -->
    
    <!-- 折叠式顶部导航 -->
    <view class="folding-nav {{ isNavCollapsed ? 'collapsed' : '' }}">
      <!-- 一级导航 (章节) -->
      <scroll-view 
        scroll-x="true" 
        class="primary-nav"
        scroll-into-view="{{primaryNavScrollId}}"
        scroll-with-animation="true"
      >
        <view 
          wx:for="{{ chapters }}" 
          wx:key="id"
          id="chapter_{{item.id}}"
          class="primary-nav-item {{ currentChapter.id === item.id ? 'active' : '' }}"
          data-chapter-id="{{ item.id }}"
          bindtap="selectChapter"
        >
          {{ currentLang === 'zh' ? item.title : item.title_en }}
          <view class="indicator" wx:if="{{ currentChapter.id === item.id }}"></view>
        </view>
      </scroll-view>
      
      <!-- 二级导航 (小节) -->
      <view class="secondary-nav {{ isSecondaryNavVisible ? 'visible' : 'hidden' }}">
        <scroll-view 
          scroll-x="true" 
          class="secondary-nav-scroll"
          scroll-into-view="{{secondaryNavScrollId}}"
          scroll-with-animation="true"
        >
          <view 
            wx:for="{{ currentChapter.sections }}" 
            wx:key="id"
            id="section_{{item.id}}"
            class="secondary-nav-item {{ currentSection.id === item.id ? 'active' : '' }}"
            data-section-id="{{ item.id }}"
            bindtap="selectSection"
          >
            {{ currentLang === 'zh' ? item.title : item.title_en }}
          </view>
        </scroll-view>
      </view>
    </view>
    
    <!-- <view class="seperator" /> -->
    <view class="step_container" wx:for="{{ chapters }}" wx:key="id" wx:for-item="chapter">
      <view id="step_{{ chapter.id }}" data-step="{{ chapter.id }}" class="step_title">
        <view class="step_id_container">
          <view class="step_id_mark">Chapter</view>
          <view class="step_id_content">{{ chapter.id }}</view>
        </view>
        <view class="font_title_2">{{ currentLang === 'zh' ? chapter.title : chapter.title_en }}</view>
      </view>
      <view class="step_content">
        <block wx:for="{{ chapter.sections }}" wx:for-item="section" wx:key="id">
          <view id="section_{{ section.id }}" class="section_title font_title_3">
            {{ currentLang === 'zh' ? section.title : section.title_en }}
          </view>
          
          <!-- 内容渲染，支持多种内容类型 -->
          <view wx:if="{{ section.contents }}">
            <block wx:for="{{ section.contents }}" wx:for-item="item" wx:key="index">
              <!-- 文本内容 -->
              <view wx:if="{{ item.type === 'text' }}" class="text_zone">
                <rich-text nodes="<p style='line-height: 26px;'>{{ item.content }}</p>" />
              </view>
              
              <!-- 代码块内容 -->
              <view wx:elif="{{ item.type === 'code' }}" class="code_zone">
                <image class="btn-copy" data-code="{{ item.content }}" bind:tap="copyCode" src="../../images/icons/copy.png" />
                <rich-text nodes="<pre style='overflow: scroll;'>{{ item.content }}</pre>" />
              </view>
              
              <!-- 图片内容 -->
              <view wx:elif="{{ item.type === 'image' }}" class="image_zone">
                <image src="../../images/{{ item.content }}" mode="widthFix" />
              </view>
              
              <!-- 带链接的文本内容 -->
              <view wx:elif="{{ item.type === 'text-link' }}" class="text_zone">
                <view>{{item.content[0]}}<text class="text_link" bind:tap="handleLinkTap" data-link-type="{{item.linkType || 'default'}}">{{item.content[1]}}</text>{{item.content[2]}}</view>
              </view>
            </block>
          </view>
          
          <!-- 兼容性处理：对于旧格式的内容（纯文本数组）使用默认渲染 -->
          <block wx:if="{{ section.content }}">
            <rich-text wx:for="{{ section.content }}" wx:key="index" nodes="<p style='line-height: 26px;'>{{ item }}</p>" />
          </block>
        </block>
      </view>
      <view class="seperator" />
    </view>
  </view>
  
  <!-- 语言切换按钮 -->
  <!-- <view class="language-toggle" bindtap="toggleLanguage">
    <text>{{ currentLang === 'zh' ? 'EN' : '中' }}</text>
  </view> -->
</view>